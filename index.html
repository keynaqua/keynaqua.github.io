<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Deezer Overlay</title>
  <style>
    body {
      margin: 0;
      padding: 10px;
      font-family: Arial, sans-serif;
      background: transparent;
      color: white;
    }
    #overlay {
      display: flex;
      align-items: center;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 16px;
      padding: 12px 16px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      width: 600px;
    }
    #cover {
      width: 64px;
      height: 64px;
      border-radius: 8px;
      margin-right: 12px;
      background: #333;
    }
    #track-info {
      flex: 1;
    }
    #track-title {
      font-size: 18px;
      font-weight: bold;
    }
    #track-artist {
      font-size: 14px;
      color: #ccc;
    }
    #progress-bar {
      width: 100%;
      height: 6px;
      background: #444;
      border-radius: 4px;
      margin-top: 10px;
      overflow: hidden;
    }
    #progress {
      height: 100%;
      width: 0%;
      background: #1db954;
      transition: width 1s linear;
    }
  </style>
</head>
<body>
  <div id="overlay">
    <img id="cover" src="" alt="Cover">
    <div id="track-info">
      <div id="track-title">Chargement...</div>
      <div id="track-artist"></div>
      <div id="progress-bar">
        <div id="progress"></div>
      </div>
    </div>
  </div>

  <script>
    const apiKey   = '90f41e0ec988a78dcc5935c83bce9ba2'; // ta vraie clé sans accents
    const username = 'Aqua_Keyn';                        // ton pseudo Last.fm
    const pollMs   = 5000;                               // intervalle de 5 s

    let currentTrackId = null;
    let trackStartTime = 0;
    let trackDuration  = 0;

    // Helper JSONP
    function jsonp(url, callbackTag) {
      return new Promise((resolve, reject) => {
        const cbName = `cb_${callbackTag}_${Date.now()}`;
        window[cbName] = data => {
          resolve(data);
          delete window[cbName];
          document.body.removeChild(script);
        };
        const script = document.createElement('script');
        script.src = `${url}&callback=${cbName}`;
        script.onerror = () => reject(new Error('JSONP load error'));
        document.body.appendChild(script);
      });
    }

    async function updateOverlay() {
      try {
        // 1) Récupère les 5 derniers tracks en JSONP
        const recent = await jsonp(
          `https://ws.audioscrobbler.com/2.0/?
            method=user.getrecenttracks
            &user=${username}
            &api_key=${apiKey}
            &format=json
            &limit=5`
            .replace(/\s+/g, ''), 'recent'
        );

        // 2) Cherche le track en cours ("nowplaying")
        const now = recent.recenttracks.track.find(t => t['@attr']?.nowplaying);
        if (!now) {
          // pas de musique live
          document.getElementById('progress').style.width = '0%';
          return;
        }

        // 3) Identifiant unique (mbid ou fallback)
        const thisId = now.mbid || now.url || now.name + now.artist['#text'];

        // 4) Si nouveau morceau, on reset et récupère durée
        if (thisId !== currentTrackId) {
          currentTrackId  = thisId;
          trackStartTime  = Date.now();

          if (now.mbid) {
            const info = await jsonp(
              `https://ws.audioscrobbler.com/2.0/?
                method=track.getInfo
                &api_key=${apiKey}
                &mbid=${now.mbid}
                &format=json`
                .replace(/\s+/g, ''), 'info'
            );
            trackDuration = Math.max(1, Math.floor(info.track.duration / 1000));
          } else {
            trackDuration = 180; // fallback
          }

          // Mise à jour de l'UI
          document.getElementById('track-title').textContent  = now.name;
          document.getElementById('track-artist').textContent = now.artist['#text'];
          document.getElementById('cover').src               = now.image[2]['#text'] || '';
        }

        // 5) Calcul et affichage de la progression
        const elapsed = (Date.now() - trackStartTime) / 1000;
        const pct     = Math.min(100, (elapsed / trackDuration) * 100);
        document.getElementById('progress').style.width = pct + '%';

      } catch (e) {
        console.error('Overlay JSONP error:', e);
      }
    }

    // Lancement initial et intervalle
    setInterval(updateOverlay, pollMs);
    updateOverlay();
  </script>
</body>
</html>
